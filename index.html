<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PHASE 15 | Body Recomp Engine</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
    .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    .input-dark { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 8px; padding: 10px; width: 100%; text-align: center; }
    .tab-active { background: #2563eb !important; color: white !important; }
    .stat-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.05); }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdnhWN3Hq5CySfu2GSse8FYv2_OksqhqQgSvI57IbLseXw4t7r8JoHbuucegB-489X/exec'; 
    const { createElement: e, useState, useEffect, useMemo } = React;

    function App() {
      const [activeTab, setActiveTab] = useState('history');
      const [workouts, setWorkouts] = useState([]);
      const [metrics, setMetrics] = useState([]);
      const [currentWorkout, setCurrentWorkout] = useState(null);
      const [exercises, setExercises] = useState([]);
      const [status, setStatus] = useState('');

      // Persistent Storage Logic
      useEffect(() => {
        const savedWorkouts = localStorage.getItem('p15_workouts');
        const savedMetrics = localStorage.getItem('p15_metrics');
        if (savedWorkouts) setWorkouts(JSON.parse(savedWorkouts));
        if (savedMetrics) setMetrics(JSON.parse(savedMetrics));
        fetchHistory(); // Sync with Cloud
      }, []);

      useEffect(() => {
        localStorage.setItem('p15_workouts', JSON.stringify(workouts));
        localStorage.setItem('p15_metrics', JSON.stringify(metrics));
      }, [workouts, metrics]);

      const fetchHistory = async () => {
        try {
          const res = await fetch(`${SCRIPT_URL}?action=getHistory`);
          const data = await res.json();
          if (data && data.length > 0) setWorkouts(data);
        } catch (err) { console.log("Offline mode active."); }
      };

      const workoutTemplates = {
        'Upper Push': [{ name: 'Bench Press', sets: 3, reps: '6-8' }, { name: 'Overhead Press', sets: 3, reps: '8-10' }],
        'Upper Pull': [{ name: 'Deadlift', sets: 3, reps: '6-8' }, { name: 'Pull Ups', sets: 3, reps: 'Max' }],
        'Lower Quad': [{ name: 'Back Squat', sets: 4, reps: '6-8' }, { name: 'Leg Press', sets: 3, reps: '12-15' }],
        'Lower Ham': [{ name: 'RDL', sets: 4, reps: '8-10' }, { name: 'Leg Curls', sets: 3, reps: '12-15' }],
        'Run - Long': [{ name: 'Aerobic Run', sets: 1, reps: '45-60m', category: 'cardio' }]
      };

      const startWorkout = (type) => {
        const template = workoutTemplates[type];
        setCurrentWorkout({ type, date: new Date().toISOString().split('T')[0] });
        setExercises(template.map(ex => ({
          ...ex,
          sets_data: Array(ex.sets).fill().map(() => ({ weight: '', reps: '' }))
        })));
        setActiveTab('workout');
      };

      const finishWorkout = async () => {
        const workoutLog = {
          type: currentWorkout.type,
          date: currentWorkout.date,
          content: exercises.map(ex => `${ex.name}: ${ex.sets_data.map(s => `${s.weight}lbs x ${s.reps}`).join('|')}`).join('\n')
        };
        
        const newWorkouts = [workoutLog, ...workouts];
        setWorkouts(newWorkouts);
        setCurrentWorkout(null);
        
        setStatus('Syncing...');
        try {
          await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ dataType: 'lift', ...workoutLog }) });
          setStatus('✓ Synced');
        } catch (e) { setStatus('Local Only'); }
      };

      // Dashboard Stats Calculation
      const stats = useMemo(() => {
        const weightLogs = metrics.filter(m => m.type === 'weight');
        const currentW = weightLogs[0]?.value || 0;
        const startW = weightLogs[weightLogs.length - 1]?.value || 0;
        return {
          streak: [...new Set(workouts.map(w => w.date))].length,
          total: workouts.length,
          loss: (startW - currentW).toFixed(1),
          current: currentW
        };
      }, [workouts, metrics]);

      return e('div', { className: 'max-w-md mx-auto p-4 pb-20' },
        e('header', { className: 'mb-8' },
          e('h1', { className: 'text-3xl font-black italic text-blue-400 uppercase leading-none' }, 'Phase 15'),
          e('p', { className: 'text-[10px] text-slate-500 font-bold uppercase tracking-widest' }, status || '31% → 15% Body Fat')
        ),

        // Navigation
        e('nav', { className: 'flex gap-2 mb-6 bg-slate-800/50 p-1 rounded-xl border border-slate-700' },
          ['history', 'workout', 'metrics'].map(tab => 
            e('button', {
              key: tab, onClick: () => setActiveTab(tab),
              className: `flex-1 py-2 text-[10px] font-bold uppercase rounded-lg transition ${activeTab === tab ? 'tab-active' : 'text-slate-400'}`
            }, tab)
          )
        ),

        // History Dashboard
        activeTab === 'history' && e('div', { className: 'space-y-6' },
          e('div', { className: 'grid grid-cols-2 gap-3' },
            [{l:'Streak', v:stats.streak, i:'fa-fire', c:'text-orange-500'}, 
             {l:'Workouts', v:stats.total, i:'fa-dumbbell', c:'text-blue-500'}, 
             {l:'Loss', v:stats.loss + ' lbs', i:'fa-trending-down', c:'text-emerald-500'}, 
             {l:'Current', v:stats.current + ' lbs', i:'fa-weight', c:'text-purple-500'}].map(s => 
              e('div', { key: s.l, className: 'stat-card p-4 rounded-2xl' },
                e('i', { className: `fas ${s.i} ${s.c} mb-1 text-xs` }),
                e('p', { className: 'text-[9px] uppercase font-bold text-slate-500' }, s.l),
                e('p', { className: 'text-lg font-black' }, s.v)
              )
            )
          ),
          
          e('div', { className: 'space-y-4' },
            e('h3', { className: 'text-xs font-black uppercase text-slate-500' }, 'Workout Details'),
            workouts.map((w, i) => e('div', { key: i, className: 'glass-card p-4 rounded-xl border-l-2 border-blue-500' },
              e('div', { className: 'flex justify-between mb-2' },
                e('span', { className: 'text-[10px] font-bold text-blue-400' }, w.date),
                e('span', { className: 'text-[10px] uppercase font-bold text-slate-500' }, w.type)
              ),
              e('pre', { className: 'text-xs text-slate-300 whitespace-pre-wrap font-sans' }, w.content)
            ))
          )
        ),

        // Workout Tab
        activeTab === 'workout' && (!currentWorkout ? (
          e('div', { className: 'grid gap-3' },
            Object.keys(workoutTemplates).map(t => e('button', { onClick: () => startWorkout(t), className: 'glass-card p-5 rounded-xl text-left border-l-4 border-blue-500 font-bold' }, t))
          )
        ) : (
          e('div', { className: 'space-y-4' },
            exercises.map((ex, exIdx) => e('div', { className: 'glass-card p-4 rounded-xl' },
              e('p', { className: 'text-xs font-bold text-blue-400 mb-3' }, ex.name),
              ex.sets_data.map((s, si) => e('div', { className: 'flex gap-2 mb-2' },
                e('input', { placeholder: 'LBS', className: 'input-dark text-sm', type: 'number', onChange: (e) => {
                  const n = [...exercises]; n[exIdx].sets_data[si].weight = e.target.value; setExercises(n);
                }}),
                e('input', { placeholder: 'REPS', className: 'input-dark text-sm', type: 'number', onChange: (e) => {
                  const n = [...exercises]; n[exIdx].sets_data[si].reps = e.target.value; setExercises(n);
                }})
              ))
            )),
            e('button', { onClick: finishWorkout, className: 'w-full bg-blue-600 py-4 rounded-xl font-bold' }, 'Sync Finished Workout')
          )
        )),

        // Metrics Tab
        activeTab === 'metrics' && e('div', { className: 'glass-card p-6 rounded-xl space-y-4' },
          e('input', { id: 'w-in', type: 'number', className: 'input-dark', placeholder: 'Enter Weight (lbs)' }),
          e('button', { className: 'w-full bg-blue-600 py-3 rounded-lg font-bold', onClick: () => {
            const v = document.getElementById('w-in').value;
            if(v) {
              const nm = [{date: new Date().toISOString().split('T')[0], type:'weight', value: parseFloat(v)}, ...metrics];
              setMetrics(nm);
              syncData({dataType:'metrics', weight: v});
            }
          }}, 'Add Weight')
        )
      );
    }
    ReactDOM.createRoot(document.getElementById('app')).render(e(App));
  </script>
</body>
</html>