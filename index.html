<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PHASE 15 | Recomp Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 12px; padding: 10px; width: 100%; text-align: center; }
        .tab-active { background: #2563eb !important; color: white !important; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); }
        .progress-fill { height: 100%; transition: width 0.8s ease; border-radius: 99px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body class="bg-slate-950">
    <div id="app"></div>

    <script type="module">
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzdnhWN3Hq5CySfu2GSse8FYv2_OksqhqQgSvI57IbLseXw4t7r8JoHbuucegB-489X/exec'; 
        const { createElement: e, useState, useEffect, useMemo } = React;

        function App() {
            const [activeTab, setActiveTab] = useState('history');
            const [workouts, setWorkouts] = useState([]);
            const [metrics, setMetrics] = useState([]);
            const [macros, setMacros] = useState({ p: 0, c: 0, f: 0 });
            const [currentWorkout, setCurrentWorkout] = useState(null);
            const [activeExercises, setActiveExercises] = useState([]);
            const [status, setStatus] = useState('');

            const targets = { p: 180, c: 200, f: 65 };

            const templates = {
                'Upper Push': [{n: 'Bench Press', s: 3}, {n: 'Overhead Press', s: 3}, {n: 'Lateral Raises', s: 3}],
                'Upper Pull': [{n: 'Deadlifts', s: 3}, {n: 'Pull Ups', s: 3}, {n: 'Bicep Curls', s: 3}],
                'Lower Quad': [{n: 'Back Squat', s: 4}, {n: 'Leg Press', s: 3}, {n: 'Calf Raises', s: 3}],
                'Lower Ham': [{n: 'RDL', s: 4}, {n: 'Leg Curls', s: 3}, {n: 'Glute Bridges', s: 3}],
                'Zone 2 Run': [{n: 'Aerobic Run', s: 1}]
            };

            useEffect(() => {
                const savedW = localStorage.getItem('p15_workouts');
                const savedM = localStorage.getItem('p15_metrics');
                if (savedW) setWorkouts(JSON.parse(savedW));
                if (savedM) setMetrics(JSON.parse(savedM));
                fetchHistory();
            }, []);

            useEffect(() => {
                localStorage.setItem('p15_workouts', JSON.stringify(workouts));
                localStorage.setItem('p15_metrics', JSON.stringify(metrics));
            }, [workouts, metrics]);

            const fetchHistory = async () => {
                if (!SCRIPT_URL.includes('http')) return;
                try {
                    const res = await fetch(`${SCRIPT_URL}?action=getHistory`);
                    const data = await res.json();
                    if (Array.isArray(data)) setWorkouts(data);
                } catch (err) { console.log("Cloud offline"); }
            };

            const startWorkout = (type) => {
                const ex = templates[type].map(t => ({
                    name: t.n,
                    sets: Array(t.s).fill().map(() => ({ w: '', r: '' }))
                }));
                setCurrentWorkout(type);
                setActiveExercises(ex);
            };

            const finishWorkout = async () => {
                const summary = activeExercises.map(ex => 
                    `${ex.name.toUpperCase()}\n` + ex.sets.map((s, i) => `Set ${i+1}: ${s.w}lbs x ${s.r}`).join('\n')
                ).join('\n\n');

                const newLog = { type: currentWorkout, date: new Date().toLocaleDateString(), content: summary };
                setWorkouts([newLog, ...workouts]);
                setCurrentWorkout(null);
                setActiveTab('history');

                setStatus('Syncing...');
                try {
                    await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ dataType: 'lift', ...newLog }) });
                    setStatus('âœ“ Saved');
                } catch (e) { setStatus('Local Only'); }
            };

            const updateSet = (exIdx, setIdx, field, val) => {
                const updated = [...activeExercises];
                updated[exIdx].sets[setIdx][field] = val;
                setActiveExercises(updated);
            };

            const stats = useMemo(() => {
                const weights = metrics.filter(m => m.type === 'weight');
                const curr = weights[0]?.value || 0;
                const start = weights[weights.length - 1]?.value || 0;
                return {
                    streak: [...new Set(workouts.map(w => w.date))].length,
                    total: workouts.length,
                    loss: (start - curr).toFixed(1),
                    curr: curr
                };
            }, [workouts, metrics]);

            return e('div', { className: 'max-w-md mx-auto p-5 pb-24' },
                e('header', { className: 'mb-8 mt-4 text-center' },
                    e('h1', { className: 'text-3xl font-black italic bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400' }, 'PHASE 15'),
                    e('p', { className: 'text-[9px] font-bold text-slate-500 uppercase tracking-widest' }, 'March 7th Race Prep')
                ),

                // SUMMARY
                e('div', { className: 'grid grid-cols-2 gap-3 mb-6' },
                    [{l:'Weight Loss', v:stats.loss + ' lbs', i:'fa-arrow-trend-down', c:'text-emerald-400'},
                     {l:'Current', v:stats.curr || '--', i:'fa-weight-scale', c:'text-purple-400'}].map(s => 
                        e('div', { key: s.l, className: 'glass-card p-4 rounded-2xl border border-slate-800' },
                            e('i', { className: `fas ${s.i} ${s.c} mb-1 text-xs` }),
                            e('p', { className: 'text-[10px] uppercase font-black text-slate-500' }, s.l),
                            e('p', { className: 'text-xl font-black' }, s.v)
                        )
                    )
                ),

                // NAV
                e('div', { className: 'flex gap-2 mb-8 bg-slate-900/80 p-1.5 rounded-2xl border border-slate-800 sticky top-4 z-50' },
                    ['history', 'workout', 'fuel', 'metrics'].map(tab => 
                        e('button', { key: tab, onClick: () => setActiveTab(tab), className: `flex-1 py-3 text-[10px] font-black uppercase rounded-xl transition-all ${activeTab === tab ? 'tab-active' : 'text-slate-500'}` }, tab)
                    )
                ),

                // HISTORY
                activeTab === 'history' && e('div', { className: 'space-y-4' },
                    workouts.map((w, i) => e('div', { key: i, className: 'glass-card p-5 rounded-2xl border-l-4 border-blue-500' },
                        e('div', { className: 'flex justify-between mb-3' },
                            e('h3', { className: 'text-sm font-black uppercase text-blue-400' }, w.type),
                            e('span', { className: 'text-[10px] font-bold text-slate-500' }, w.date)
                        ),
                        e('pre', { className: 'text-[11px] text-slate-300 leading-tight font-medium' }, w.content)
                    ))
                ),

                // WORKOUT
                activeTab === 'workout' && (!currentWorkout ? (
                    e('div', { className: 'space-y-3' },
                        Object.keys(templates).map(t => e('button', { onClick: () => startWorkout(t), className: 'w-full glass-card p-5 rounded-2xl text-left font-black uppercase text-sm border border-slate-800 hover:border-blue-500 transition' }, t))
                    )
                ) : (
                    e('div', { className: 'space-y-4' },
                        e('h2', { className: 'text-xl font-black text-blue-400 mb-4' }, currentWorkout),
                        activeExercises.map((ex, exIdx) => e('div', { key: exIdx, className: 'glass-card p-4 rounded-2xl border border-slate-800' },
                            e('p', { className: 'text-xs font-black uppercase text-emerald-400 mb-3' }, ex.name),
                            ex.sets.map((s, si) => e('div', { key: si, className: 'flex gap-2 mb-2' },
                                e('input', { type: 'number', placeholder: 'LBS', className: 'input-dark text-xs flex-1', value: s.w, onChange: (v) => updateSet(exIdx, si, 'w', v.target.value) }),
                                e('input', { type: 'number', placeholder: 'REPS', className: 'input-dark